<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1099 Manager</title>
    
    <!-- Tailwind & Dark Mode Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- Icons & Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE SDK (For Auth) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDjtmRPzKilbqHGt57SvVm5fo3KyZ9D03U",
            authDomain: "truck-dashboard-18d7e.firebaseapp.com",
            projectId: "truck-dashboard-18d7e",
            storageBucket: "truck-dashboard-18d7e.firebasestorage.app",
            messagingSenderId: "594927367199",
            appId: "1:594927367199:web:4f3c5af05f4cfdb482112a",
            measurementId: "G-42RMFB41Q2"
        };

        let auth;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            
            // --- AUTH CHECK ---
            // If Admin, skip check. If not, verify user.
            if (localStorage.getItem('admin_mode') === 'true') {
                 const el = document.getElementById('userName');
                 if(el) el.innerHTML = '<span class="text-green-500 font-bold">Administrator</span>';
            } else {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const rawName = user.email.split('@')[0];
                        const niceName = rawName.charAt(0).toUpperCase() + rawName.slice(1);
                        const el = document.getElementById('userName');
                        if(el) el.innerText = niceName;
                    } else {
                        goHome(); 
                    }
                });
            }
        } catch(e) { console.error(e); }

        window.logout = function() {
            localStorage.removeItem('my_access_key');
            localStorage.removeItem('admin_mode'); 
            if (auth) {
                signOut(auth).then(() => goHome()).catch(() => goHome());
            } else {
                goHome();
            }
        };

        function goHome() {
            try {
                if (window.location.protocol !== 'blob:') {
                    window.location.href = "index.html";
                } else {
                    document.body.innerHTML = "<div class='text-center p-10'><h1>Auth Required</h1><a href='index.html'>Login</a></div>";
                }
            } catch(e) {}
        }
    </script>
</head>
<body class="text-gray-800 bg-gray-50 font-sans dark:bg-gray-900 dark:text-gray-100" onload="initApp()">

    <!-- Header / Navbar -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm p-4 sticky top-0 z-50 transition-colors duration-300">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="dashboard.html" class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div class="font-bold text-xl text-gray-700 dark:text-white flex items-center">
                    <i class="fas fa-truck-moving text-blue-600 mr-2"></i> 1099 Manager
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="toggleTheme()" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition focus:outline-none">
                    <i id="themeIcon" class="fas fa-lightbulb text-gray-400"></i>
                </button>
                <div class="hidden md:flex items-center text-sm font-medium text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 px-3 py-1.5 rounded-full border dark:border-gray-600">
                    <i class="fas fa-user-circle text-blue-500 mr-2 text-lg"></i>
                    <span id="userName">Loading...</span>
                </div>
                <button onclick="logout()" class="text-xs font-bold text-red-500 hover:text-white border border-red-200 dark:border-red-900 hover:bg-red-500 px-4 py-2 rounded-lg transition shadow-sm flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i> Log Out
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        
        <!-- Controls -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 border border-gray-100 dark:border-gray-700">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex-1 w-full">
                    <label class="block text-xs font-bold text-blue-800 dark:text-blue-400 uppercase mb-1">Active Company</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <select id="companySelect" onchange="switchCompany(this.value)" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 appearance-none focus:ring-2 focus:ring-blue-500 outline-none font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 cursor-pointer"></select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-400"><i class="fas fa-chevron-down text-xs"></i></div>
                        </div>
                        <button onclick="openNewCompanyModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm whitespace-nowrap"><i class="fas fa-plus mr-1"></i> New</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="document.getElementById('restoreInput').click()" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg transition text-sm font-medium border dark:border-gray-600"><i class="fas fa-upload mr-2"></i> Restore</button>
                    <input type="file" id="restoreInput" class="hidden" accept=".json" onchange="restoreData(this)">
                    <button onclick="backupData()" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg transition text-sm font-medium border dark:border-gray-600"><i class="fas fa-download mr-2"></i> Backup</button>
                </div>
                <div class="flex items-center gap-3 bg-gray-50 dark:bg-gray-900 px-4 py-2 rounded-lg border dark:border-gray-700">
                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">View:</span>
                    <div class="flex gap-1">
                        <button id="btnViewCurrent" onclick="switchView('current')" class="px-3 py-1 rounded-md text-sm font-medium transition bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-sm border dark:border-gray-600">Current</button>
                        <button id="btnViewGlobal" onclick="switchView('global')" class="px-3 py-1 rounded-md text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition">Global</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- LEFT: Upload Zone -->
            <div class="lg:col-span-1" id="uploadSection">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 h-full flex flex-col relative border border-gray-100 dark:border-gray-700">
                    <h2 class="font-bold text-lg mb-4 text-gray-700 dark:text-white">1. Upload Files</h2>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Adding to: <span id="uploadTargetCompany" class="font-bold text-blue-600 dark:text-blue-400">...</span></p>
                    <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl flex-1 flex flex-col justify-center items-center p-8 text-center cursor-pointer min-h-[200px] bg-gray-50 dark:bg-gray-900 hover:bg-blue-50 dark:hover:bg-gray-800 transition-colors" onclick="document.getElementById('fileInput').click()">
                        <div class="bg-blue-100 dark:bg-blue-900 p-4 rounded-full mb-3"><i class="fas fa-file-pdf text-blue-500 dark:text-blue-300 text-2xl"></i></div>
                        <p class="font-medium text-gray-700 dark:text-gray-300">Click to upload</p>
                        <p class="text-sm text-gray-400">or drag & drop PDFs</p>
                        <input type="file" id="fileInput" class="hidden" accept="application/pdf" multiple onchange="handleFiles(this.files)">
                    </div>
                    <div id="globalOverlay" class="absolute inset-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm z-10 hidden flex flex-col items-center justify-center rounded-lg text-center p-6">
                        <i class="fas fa-lock text-gray-400 text-3xl mb-2"></i>
                        <p class="font-bold text-gray-600 dark:text-gray-300">Upload Disabled</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Switch to "Current" view.</p>
                    </div>
                    <div id="processingStatus" class="mt-4 hidden">
                        <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400 mb-1"><span>Processing...</span><span id="progressText">0%</span></div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Results Table -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 min-h-[500px] border border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg text-gray-700 dark:text-white" id="reportTitle">Report</h2>
                        <div class="flex gap-2">
                            <button onclick="openClearModal()" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 px-3 py-1.5 rounded-lg transition text-sm border border-transparent hover:border-red-100 dark:hover:border-red-900"><i class="fas fa-trash-alt mr-1"></i> Clear</button>
                            <button onclick="printReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium shadow-sm"><i class="fas fa-print mr-2"></i> Print PDF</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 uppercase text-xs tracking-wider">
                                    <th class="p-3 font-semibold w-1/4">Unit #</th>
                                    <th class="p-3 font-semibold w-1/4">Driver / Note</th>
                                    <th class="p-3 font-semibold text-right w-1/4">AFTER COMMISSION</th>
                                    <th class="p-3 font-semibold text-center w-1/4">Details</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="text-sm text-gray-700 dark:text-gray-300 divide-y divide-gray-100 dark:divide-gray-700">
                                <tr><td colspan="4" class="p-8 text-center text-gray-400">No data yet.</td></tr>
                            </tbody>
                            <tfoot id="tableFooter" class="hidden">
                                <tr class="bg-blue-50 dark:bg-blue-900/30 font-bold text-gray-800 dark:text-white border-t-2 border-blue-100 dark:border-blue-800">
                                    <td class="p-3">TOTAL</td>
                                    <td class="p-3"></td>
                                    <td class="p-3 text-right" id="grandTotal">$0.00</td>
                                    <td class="p-3"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="newCompanyModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 shadow-xl border dark:border-gray-700">
            <h3 class="text-lg font-bold mb-4 dark:text-white">Add Company</h3>
            <input type="text" id="newCompanyName" class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg p-3 mb-4 outline-none" placeholder="Company Name...">
            <div class="flex justify-end gap-2">
                <button onclick="closeNewCompanyModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="confirmNewCompany()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 shadow-xl border dark:border-gray-700">
            <h3 class="text-lg font-bold mb-4 dark:text-white">Edit Unit</h3>
            <input type="text" id="editUnitInput" class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg p-2 mb-4 outline-none">
            <input type="hidden" id="editFileIndex">
            <div class="flex justify-end gap-2">
                <button onclick="closeEditModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="saveUnitEdit()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <div id="notesModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 shadow-xl border dark:border-gray-700">
            <h3 class="text-lg font-bold mb-4 dark:text-white">Notes</h3>
            <textarea id="noteInput" class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg p-3 mb-4 h-32 outline-none resize-none"></textarea>
            <input type="hidden" id="noteKey">
            <div class="flex justify-end gap-2">
                <button onclick="closeNotesModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="saveNote()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    
    <div id="deleteFileModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 shadow-xl border dark:border-gray-700">
            <h3 class="text-lg font-bold mb-4 text-red-600 dark:text-red-400">Delete File?</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Confirm deletion.</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeDeleteFileModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="confirmDeleteFile()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Delete</button>
            </div>
        </div>
    </div>

    <div id="clearModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 shadow-xl border dark:border-gray-700">
            <h3 class="text-lg font-bold mb-4 text-red-600 dark:text-red-400">Clear Data?</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">This will delete data for current view.</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeClearModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="confirmClear()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Clear</button>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIC (PASTED & RESTORED) -->
    <script>
        let appData = []; let unitNotes = {}; let restoreCandidate = null; let viewMode = 'current'; let fileToDeleteId = null;
        let knownCompanies = ["Default Company"]; let currentCompany = "Default Company";

        function initApp() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') { document.documentElement.classList.add('dark'); updateBulbIcon(true); }
            updateCompanyDropdown(); renderTable();
        }

        window.handleFiles = async function(files) {
            if (viewMode === 'global') { alert("Please switch to 'Current' view."); return; }
            const fileArray = [...files].filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
            if(fileArray.length === 0) { alert("No PDFs found."); return; }
            document.getElementById('processingStatus').classList.remove('hidden');
            const pb = document.getElementById('progressBar');
            for (let i = 0; i < fileArray.length; i++) {
                const file = fileArray[i];
                if (appData.some(d => d.filename === file.name && d.company === currentCompany)) continue;
                try {
                    const data = await extractDataFromPDF(file);
                    data.id = Date.now() + Math.random().toString(36).substr(2, 9);
                    data.company = currentCompany;
                    appData.push(data);
                } catch(e) { console.error(e); }
                pb.style.width = Math.round(((i + 1) / fileArray.length) * 100) + "%";
            }
            setTimeout(() => { document.getElementById('processingStatus').classList.add('hidden'); pb.style.width="0%"; }, 1000);
            renderTable();
        };

        // --- PDF PARSING (THE PERFECT LOGIC) ---
        async function extractDataFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 1.0 });
            const textContent = await page.getTextContent();
            
            // Critical: Right side only
            const rightSideBoundary = viewport.width * 0.4;
            const rightSideItems = textContent.items.filter(item => item.transform[4] > rightSideBoundary);
            rightSideItems.sort((a, b) => b.transform[5] - a.transform[5]);

            let lines = [], currentLine = [], lastY = -1;
            rightSideItems.forEach(item => {
                if (lastY === -1 || Math.abs(item.transform[5] - lastY) < 6) currentLine.push(item);
                else { currentLine.sort((a, b) => a.transform[4] - b.transform[4]); lines.push(currentLine); currentLine = [item]; }
                lastY = item.transform[5];
            });
            if(currentLine.length) lines.push(currentLine);

            let textLines = lines.map(line => ({ text: line.map(i => i.str).join(' ').trim(), y: line[0].transform[5], items: line }));
            
            let unit = "Unknown", name = "Unknown", amount = 0.0;

            for(let l of textLines) {
                const m = l.text.match(/\b(?:Unit|Truck|Trk|Trlr)\b\s*[:#.]?\s*([A-Za-z0-9\-\s]+)/i);
                if(m) { let c = m[1].trim().split(/Driver|Date|Pay|Total|Statement|Page/i)[0].trim(); if(c) { unit = c; break; } }
            }

            if(name === "Unknown") {
                for(let i=0; i<textLines.length; i++) {
                    if(/\b(unit|truck)\b/i.test(textLines[i].text.toLowerCase())) {
                        for(let j=1; j<=3; j++) {
                            if(i+j < textLines.length) {
                                const pm = textLines[i+j].text.match(/^\((.+?)\)$/);
                                if(pm) { name = pm[1].trim(); break; }
                            }
                        }
                    }
                    if(name !== "Unknown") break;
                }
            }
            let isCompanyDriver = false;
            if(name === "Unknown") {
                for(let i=0; i<textLines.length; i++) {
                    const txt = textLines[i].text.toUpperCase();
                    if(txt === 'STATEMENT' || txt.endsWith(' STATEMENT')) {
                        if(i+1 < textLines.length) {
                            const nt = textLines[i+1].text;
                            if(!/\d/.test(nt) && !/truck|unit|#/i.test(nt) && nt.length > 2) {
                                name = nt; isCompanyDriver = true; break;
                            }
                        }
                    }
                }
            }
            if(isCompanyDriver) unit = ""; 
            if(name === "Unknown") {
                for(let l of textLines) {
                    const m = l.text.match(/(?:Driver|Driver Name|Pay to)\s*[:#.]?\s*([A-Za-z\s\.]+)/i);
                    if(m) { name = m[1].trim(); break; }
                }
            }

            const fullItems = textContent.items.sort((a, b) => b.transform[5] - a.transform[5]);
            let fullLines = [], cLine = [], lY = -1;
            fullItems.forEach(i => {
                if (lY === -1 || Math.abs(i.transform[5] - lY) < 6) cLine.push(i);
                else { cLine.sort((a,b)=>a.transform[4]-b.transform[4]); fullLines.push(cLine.map(x=>x.str).join(' ')); cLine=[i]; }
                lY = i.transform[5];
            });
            if(cLine.length) fullLines.push(cLine.map(x=>x.str).join(' '));

            if(isCompanyDriver) {
                let found = false;
                for(let l of fullLines) {
                    if(/check total|net pay|check amount/i.test(l)) {
                        const m = l.match(/(\d{1,3}(?:,\d{3})*\.\d{2})/);
                        if(m) { amount = parseFloat(m[1].replace(',','')); found=true; }
                    }
                }
                if(!found) {
                     for(let i=fullLines.length-1; i>=0; i--) {
                         if(/total/i.test(fullLines[i])) {
                             const m = fullLines[i].match(/(\d{1,3}(?:,\d{3})*\.\d{2})/);
                             if(m) { amount = parseFloat(m[1].replace(',','')); break; }
                         }
                     }
                }
            } else {
                let tf = false;
                for(let l of fullLines) {
                    if(/trip/i.test(l)) tf=true;
                    if(tf && /total/i.test(l)) {
                        const m = l.match(/(\d{1,3}(?:,\d{3})*\.\d{2})/);
                        if(m) { amount = parseFloat(m[1].replace(',','')); break; }
                    }
                }
                if(amount === 0) {
                     for(let l of fullLines) {
                         if(/total/i.test(l)) {
                             const m = l.match(/(\d{1,3}(?:,\d{3})*\.\d{2})/);
                             if(m) { amount = parseFloat(m[1].replace(',','')); break; }
                         }
                     }
                }
            }
            return { unit, name, amount, filename: file.name };
        }

        // --- UI & TABLE ---
        function getCommissionLabel(unitStr) {
            if (!unitStr) return "";
            if (unitStr.includes("287") || unitStr.includes("3781")) return "(10%)";
            return "(12%)";
        }
        function updateCompanyDropdown() {
            const s = document.getElementById('companySelect'); s.innerHTML='';
            knownCompanies.forEach(c=>{const o=document.createElement('option');o.text=c;if(c===currentCompany)o.selected=true;s.add(o);});
            document.getElementById('uploadTargetCompany').innerText=currentCompany;
        }
        window.switchCompany = function(n) { currentCompany=n; updateCompanyDropdown(); renderTable(); }
        window.openNewCompanyModal = function() { document.getElementById('newCompanyModal').classList.remove('hidden'); }
        window.closeNewCompanyModal = function() { document.getElementById('newCompanyModal').classList.add('hidden'); }
        window.confirmNewCompany = function() { const n=document.getElementById('newCompanyName').value.trim(); if(n&&!knownCompanies.includes(n)){knownCompanies.push(n);switchCompany(n);closeNewCompanyModal();} }
        
        window.switchView = function(m) {
            viewMode=m; const bC=document.getElementById('btnViewCurrent'), bG=document.getElementById('btnViewGlobal'), o=document.getElementById('globalOverlay'), t=document.getElementById('reportTitle');
            const on=['bg-white','dark:bg-gray-700','text-blue-600','dark:text-blue-400','shadow-sm'], off=['text-gray-500','dark:text-gray-400'];
            if(m==='current'){ bC.classList.add(...on);bC.classList.remove(...off);bG.classList.remove(...on);bG.classList.add(...off);o.classList.add('hidden');t.innerText=`${currentCompany} Report`; }
            else { bG.classList.add(...on);bG.classList.remove(...off);bC.classList.remove(...on);bC.classList.add(...off);o.classList.remove('hidden');t.innerText="Global Report"; }
            renderTable();
        }

        function renderTable() {
            const tbody=document.getElementById('dataTableBody'), footer=document.getElementById('tableFooter'), gt=document.getElementById('grandTotal');
            let data = (viewMode==='current') ? appData.filter(i=>i.company===currentCompany) : appData;
            if(!data.length){ tbody.innerHTML=`<tr><td colspan="4" class="p-8 text-center text-gray-400">No data.</td></tr>`; footer.classList.add('hidden'); return; }
            footer.classList.remove('hidden');

            const agg = {};
            data.forEach(i=>{
                let k = (i.unit&&i.unit!=="Unknown")?i.unit.toUpperCase():i.name.toUpperCase();
                if(!agg[k]) agg[k]={unit:i.unit, name:i.name, total:0, files:[]};
                agg[k].total+=i.amount; agg[k].files.push(i);
                if(agg[k].name==="Unknown" && i.name!=="Unknown") agg[k].name=i.name;
            });
            const own=[], drv=[];
            Object.values(agg).forEach(i=>(i.unit&&i.unit!=="")?own.push(i):drv.push(i));
            const sFn = (a,b) => { if(a.unit&&b.unit){const nA=parseInt(a.unit.replace(/\D/g,'')),nB=parseInt(b.unit.replace(/\D/g,''));if(!isNaN(nA)&&!isNaN(nB))return nA-nB;} return (a.name||"").localeCompare(b.name||""); };
            own.sort(sFn); drv.sort(sFn);

            let html='', sum=0;
            const row = (l) => l.forEach(g => {
                sum+=g.total; const sid = (g.unit||g.name).replace(/[^a-zA-Z0-9]/g,'_');
                const nk=`${currentCompany}_${g.unit||g.name}`, note=unitNotes[nk]||"";
                const nc=note?"text-yellow-500":"text-gray-300 dark:text-gray-600 hover:text-blue-500";
                const rate = g.unit ? getCommissionLabel(g.unit) : "";
                html += `
                <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <td class="p-3 font-bold dark:text-gray-200">${g.unit||""}</td>
                    <td class="p-3 text-gray-600 dark:text-gray-400 flex justify-between"><span>${g.name}</span>${viewMode==='current'?`<button onclick="openNotesModal('${g.unit||g.name}')" class="${nc}"><i class="fas fa-sticky-note"></i></button>`:''}</td>
                    <td class="p-3 text-right font-mono text-blue-700 dark:text-blue-400">$${g.total.toLocaleString('en-US',{minimumFractionDigits:2})} <span class="text-xs text-gray-400">${rate}</span></td>
                    <td class="p-3 text-center"><button onclick="document.getElementById('det-${sid}').classList.toggle('hidden')" class="text-xs bg-blue-50 dark:bg-blue-900 text-blue-600 px-3 py-1 rounded-full">Files</button></td>
                </tr>
                <tr id="det-${sid}" class="hidden bg-gray-50 dark:bg-gray-900"><td colspan="4" class="p-0"><div class="p-4 border-l-4 border-blue-200 dark:border-blue-800"><ul class="space-y-2">${g.files.map(f=>`<li class="flex justify-between text-sm dark:text-gray-300"><span>${f.filename}</span><div class="flex gap-2 font-mono">$${f.amount.toLocaleString('en-US',{minimumFractionDigits:2})} ${viewMode==='current'?`<button onclick="deleteFile('${f.id}')" class="text-red-400"><i class="fas fa-trash"></i></button>`:''}</div></li>`).join('')}</ul></div></td></tr>`;
            });
            if(own.length) row(own);
            if(drv.length) { html+=`<tr class="bg-gray-100 dark:bg-gray-700 font-bold dark:text-white"><td colspan="4" class="p-2 pl-4 text-xs uppercase">Drivers</td></tr>`; row(drv); }
            
            tbody.innerHTML=html; gt.innerText="$"+sum.toLocaleString('en-US',{minimumFractionDigits:2});
        }
        
        // --- Modal & Data Helpers ---
        window.toggleTheme = function() { 
            const d=document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('theme', d?'dark':'light'); 
            updateBulbIcon(d); 
        }
        function updateBulbIcon(d) { 
            const i=document.getElementById('themeIcon'); 
            if(i) i.classList.toggle('text-yellow-400',d); 
        }
        window.openNotesModal = function(k) { document.getElementById('noteKey').value=`${currentCompany}_${k}`; document.getElementById('noteInput').value=unitNotes[`${currentCompany}_${k}`]||""; document.getElementById('notesModal').classList.remove('hidden'); }
        window.closeNotesModal = function() { document.getElementById('notesModal').classList.add('hidden'); }
        window.saveNote = function() { unitNotes[document.getElementById('noteKey').value]=document.getElementById('noteInput').value; closeNotesModal(); renderTable(); }
        window.openClearModal = function() { document.getElementById('clearModal').classList.remove('hidden'); }
        window.closeClearModal = function() { document.getElementById('clearModal').classList.add('hidden'); }
        window.confirmClear = function() { if(viewMode==='global'){appData=[];unitNotes={};knownCompanies=["Default Company"];}else{appData=appData.filter(i=>i.company!==currentCompany);} renderTable(); closeClearModal(); }
        window.deleteFile = function(id) { fileToDeleteId=id; document.getElementById('deleteFileModal').classList.remove('hidden'); }
        window.closeDeleteFileModal = function() { document.getElementById('deleteFileModal').classList.add('hidden'); }
        window.confirmDeleteFile = function() { appData=appData.filter(d=>d.id!==fileToDeleteId); renderTable(); closeDeleteFileModal(); }
        
        // --- PRINT ---
        window.printReport = function() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFontSize(16); doc.text(viewMode==='current'?`Report: ${currentCompany}`:"Global Report",14,20);
            
            // Re-calc for PDF
            let data = (viewMode==='current') ? appData.filter(i=>i.company===currentCompany) : appData;
            const agg = {};
            data.forEach(i=>{
                let k = (i.unit&&i.unit!=="Unknown")?i.unit:i.name;
                if(!agg[k]) agg[k]={unit:i.unit,name:i.name,total:0};
                agg[k].total+=i.amount;
                if(agg[k].name==="Unknown"&&i.name!=="Unknown") agg[k].name=i.name;
            });
            const own=[], drv=[];
            Object.values(agg).forEach(i=>(i.unit&&i.unit!=="")?own.push(i):drv.push(i));
            own.sort((a,b)=>parseInt(a.unit)-parseInt(b.unit)); drv.sort((a,b)=>a.name.localeCompare(b.name));

            let y=35;
            if(own.length) {
                const rows = own.map(r=>[r.unit, r.name+(unitNotes[`${currentCompany}_${r.unit}`]?` (Note: ${unitNotes[`${currentCompany}_${r.unit}`]})`:""), `$${r.total.toFixed(2)} ${getCommissionLabel(r.unit)}`]);
                rows.push(["","TOTAL OWNERS", `$${own.reduce((a,c)=>a+c.total,0).toFixed(2)}`]);
                doc.autoTable({head:[['Unit','Name','Amount']], body:rows, startY:y});
                y = doc.lastAutoTable.finalY + 10;
            }
            if(drv.length) {
                doc.text("DRIVERS", 14, y); y+=5;
                const rows = drv.map(r=>[r.name+(unitNotes[`${currentCompany}_${r.name}`]?` (Note: ${unitNotes[`${currentCompany}_${r.name}`]})`:""), `$${r.total.toFixed(2)}`]);
                rows.push(["TOTAL DRIVERS", `$${drv.reduce((a,c)=>a+c.total,0).toFixed(2)}`]);
                doc.autoTable({head:[['Name','Amount']], body:rows, startY:y});
            }
            doc.save("Report.pdf");
        }

        // --- BACKUP/RESTORE ---
        window.backupData = function() {
            if(!appData.length)return;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify({version:2,appData,unitNotes,knownCompanies})], {type:"application/json"}));
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }
        window.restoreData = function(inp) {
            const f=inp.files[0]; if(!f)return;
            const r=new FileReader();
            r.onload=e=>{
                try {
                    const j=JSON.parse(e.target.result);
                    if(j.appData) { appData=j.appData; unitNotes=j.unitNotes||{}; knownCompanies=j.knownCompanies||["Default Company"]; }
                    else { appData=j; } // Legacy support
                    updateCompanyDropdown(); renderTable();
                } catch(x){alert("Error");}
            };
            r.readAsText(f); inp.value='';
        }
    </script>
</body>
</html>
