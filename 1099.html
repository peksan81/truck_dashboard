<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1099 Manager</title>
    
    <!-- Tailwind & Dark Mode Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <!-- Icons & Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- FIREBASE SDK (Auth & Firestore) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // REMOVED enableIndexedDbPersistence to fix lock issues
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDjtmRPzKilbqHGt57SvVm5fo3KyZ9D03U",
            authDomain: "truck-dashboard-18d7e.firebaseapp.com",
            projectId: "truck-dashboard-18d7e",
            storageBucket: "truck-dashboard-18d7e.firebasestorage.app",
            messagingSenderId: "594927367199",
            appId: "1:594927367199:web:4f3c5af05f4cfdb482112a",
            measurementId: "G-42RMFB41Q2"
        };

        // GLOBAL VARIABLES
        window.appData = []; 
        window.unitNotes = {}; 
        window.restoreCandidate = null;
        window.viewMode = 'current'; 
        window.fileToDeleteId = null;
        window.knownCompanies = ["Default Company"];
        window.currentCompany = "Default Company";
        let auth, db;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // Persistence removed to prevent "Client Offline" loop on page navigation

            // --- AUTH CHECK ---
            if (localStorage.getItem('admin_mode') === 'true') {
                 // Admin logic
            } else {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const rawName = user.email.split('@')[0];
                        const niceName = rawName.charAt(0).toUpperCase() + rawName.slice(1);
                        const el = document.getElementById('userName');
                        if(el) el.innerText = niceName;
                    } else {
                        goHome(); 
                    }
                });
            }
        } catch(e) { console.error(e); }

        window.logout = function() {
            localStorage.removeItem('my_access_key');
            localStorage.removeItem('admin_mode'); 
            if (auth) {
                signOut(auth).then(() => goHome()).catch(() => goHome());
            } else {
                goHome();
            }
        };

        function goHome() {
            try {
                if (window.location.protocol !== 'blob:') {
                    window.location.href = "index.html";
                } else {
                    document.body.innerHTML = "<div class='text-center p-10'><h1>Auth Required</h1><a href='index.html'>Login</a></div>";
                }
            } catch(e) {}
        }

        // --- CLOUD FUNCTIONS ---
        window.saveToCloud = async function() {
            if (localStorage.getItem('admin_mode') === 'true') { alert("Cloud save disabled in Admin Mode."); return; }
            if (!auth || !auth.currentUser) { alert("Please login to save."); return; }
            
            const btn = document.getElementById('btnSaveCloud');
            const originalHTML = btn.innerHTML;
            const statusText = document.getElementById('cloudStatus');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const user = auth.currentUser;
                await setDoc(doc(db, "users", user.uid, "data", "1099_backup"), {
                    version: 2, appData: window.appData, unitNotes: window.unitNotes, knownCompanies: window.knownCompanies, lastUpdated: new Date().toISOString()
                });
                
                // SUCCESS UI
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                
                const now = new Date();
                statusText.innerText = "Saved: " + now.toLocaleTimeString();
                statusText.classList.remove('text-gray-400', 'text-red-500');
                statusText.classList.add('text-green-600');

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                }, 2000);
                
            } catch(e) {
                console.error(e);
                statusText.innerText = "Save failed!";
                statusText.classList.remove('text-gray-400', 'text-green-600');
                statusText.classList.add('text-red-500');
                alert("Cloud Error: " + e.message + "\n\nTip: Try the 'Backup' button (File download) instead if this persists.");
            } finally {
                btn.disabled = false;
            }
        };

        window.loadFromCloud = async function() {
            if (localStorage.getItem('admin_mode') === 'true') { alert("Cloud load disabled in Admin Mode."); return; }
            if (!auth || !auth.currentUser) { alert("Please login to load."); return; }
            
            const btn = document.getElementById('btnLoadCloud');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const user = auth.currentUser;
                // Simple getDoc without persistence lock
                const snap = await getDoc(doc(db, "users", auth.currentUser.uid, "data", "1099_backup"));
                
                if(snap.exists()) {
                    const json = snap.data();
                    if(confirm("Load backup from " + new Date(json.lastUpdated).toLocaleString() + "?")) {
                        window.appData = json.appData || [];
                        window.unitNotes = json.unitNotes || {};
                        window.knownCompanies = json.knownCompanies || ["Default Company"];
                        
                        if(window.appData.length > 0 && window.appData[window.appData.length-1].company) {
                            window.currentCompany = window.appData[window.appData.length-1].company;
                        } else {
                            window.currentCompany = window.knownCompanies[0];
                        }
                        updateCompanyDropdown(); 
                        renderTable();
                        document.getElementById('cloudStatus').innerText = "Loaded: " + new Date().toLocaleTimeString();
                    }
                } else { alert("No backup found in Cloud."); }
            } catch(e) { 
                console.error(e);
                alert("Cloud Error: " + e.message + "\n\nCheck your internet connection."); 
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        };

        window.initApp = function() {
            // Theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                updateBulbIcon(true);
            }
            
            // Admin UI
            if (localStorage.getItem('admin_mode') === 'true') {
                 const el = document.getElementById('userName');
                 if(el) el.innerHTML = '<span class="text-green-500 font-bold">Administrator</span>';
            }

            // Setup Dropzone
            const dropZone = document.getElementById('dropZone');
            ['dragenter','dragover','dragleave','drop'].forEach(e => dropZone.addEventListener(e, preventDefaults, false));
            dropZone.addEventListener('drop', handleDrop, false);

            updateCompanyDropdown();
            renderTable();
        };

        function updateCompanyDropdown() {
            const select = document.getElementById('companySelect');
            if (!select) return;

            select.innerHTML = '';
            knownCompanies.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                select.appendChild(option);
            });

            if (!knownCompanies.includes(currentCompany)) {
                currentCompany = knownCompanies[0] || "Default Company";
            }
            select.value = currentCompany;
        }

        window.setViewMode = function(mode) {
            viewMode = mode;
            const currentBtn = document.getElementById('viewCurrentBtn');
            const globalBtn = document.getElementById('viewGlobalBtn');
            if (currentBtn && globalBtn) {
                if (mode === 'current') {
                    currentBtn.classList.add('bg-indigo-600', 'text-white');
                    currentBtn.classList.remove('bg-gray-200', 'text-gray-700');
                    globalBtn.classList.add('bg-gray-200', 'text-gray-700');
                    globalBtn.classList.remove('bg-green-600', 'text-white');
                } else {
                    globalBtn.classList.add('bg-green-600', 'text-white');
                    globalBtn.classList.remove('bg-gray-200', 'text-gray-700');
                    currentBtn.classList.add('bg-gray-200', 'text-gray-700');
                    currentBtn.classList.remove('bg-indigo-600', 'text-white');
                }
            }
            renderTable();
        };

        function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
        function handleDrop(e){ window.handleFiles(e.dataTransfer.files); }

        window.handleFiles = async function(files) {
            if (viewMode === 'global') {
                alert("Please switch to 'Current' view to upload files.");
                return;
            }

            const fileArray = [...files].filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
            
            if(fileArray.length === 0) {
                alert("No valid PDF files found.");
                return;
            }

            document.getElementById('processingStatus').classList.remove('hidden');
            const pb = document.getElementById('progressBar');
            const pt = document.getElementById('progressText');

            for (let i = 0; i < fileArray.length; i++) {
                const file = fileArray[i];
                if (appData.some(d => d.filename === file.name && d.company === currentCompany)) continue;

                try {
                    const data = await extractDataFromPDF(file);
                    data.id = Date.now() + Math.random().toString(36).substr(2, 9);
                    data.company = currentCompany;
                    appData.push(data);
                } catch(e) {
                    console.error("Error parsing " + file.name, e);
                }

                const pct = Math.round(((i + 1) / fileArray.length) * 100);
                pb.style.width = pct + "%";
                pt.innerText = pct + "%";
            }

            setTimeout(() => {
                document.getElementById('processingStatus').classList.add('hidden');
                pb.style.width = "0%";
            }, 1000);

            renderTable();
        };

        // --- PDF PARSING CORE (GEOMETRIC/SPATIAL APPROACH) ---
        async function extractDataFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 1.0 });
            const textContent = await page.getTextContent();
            
            // --- CRITICAL FILTER: IGNORE LEFT SIDE ---
            const rightSideBoundary = viewport.width * 0.4;
            const rightSideItems = textContent.items.filter(item => item.transform[4] > rightSideBoundary);
            rightSideItems.sort((a, b) => b.transform[5] - a.transform[5]);

            let lines = [], currentLine = [], lastY = -1;
            rightSideItems.forEach(item => {
                if (lastY === -1 || Math.abs(item.transform[5] - lastY) < 6) {
                    currentLine.push(item);
                } else {
                    currentLine.sort((a, b) => a.transform[4] - b.transform[4]);
                    lines.push(currentLine);
                    currentLine = [item];
                }
                lastY = item.transform[5];
            });
            if (currentLine.length > 0) lines.push(currentLine);

            let textLines = lines.map(line => {
                return {
                    text: line.map(item => item.str).join(' ').trim(), 
                    y: line[0].transform[5],
                    items: line
                };
            });

            // --- EXTRACTION VARIABLES ---
            let unit = "Unknown";
            let name = "Unknown";
            let amount = 0.0;

            // 2. EXTRACT UNIT 
            for (let i = 0; i < textLines.length; i++) {
                const txt = textLines[i].text;
                const match = txt.match(/\b(?:Unit|Truck|Trk|Trlr)\b\s*[:#.]?\s*([A-Za-z0-9\-\s]+)/i);
                if (match) {
                    let candidate = match[1].trim();
                    candidate = candidate.split(/Driver|Date|Pay|Total|Statement|Page/i)[0].trim();
                    if(candidate.length > 0) {
                        unit = candidate;
                        break; 
                    }
                }
            }

            // 3. EXTRACT NAME 
            if (name === "Unknown") {
                for (let i = 0; i < textLines.length; i++) {
                    const txt = textLines[i].text.toLowerCase();
                    if (/\b(unit|truck)\b/i.test(txt)) {
                        for (let j = 1; j <= 3; j++) {
                            if (i + j < textLines.length) {
                                const nextTxt = textLines[i+j].text;
                                const parenMatch = nextTxt.match(/^\((.+?)\)$/);
                                if (parenMatch) {
                                    name = parenMatch[1].trim();
                                    break;
                                }
                            }
                        }
                    }
                    if (name !== "Unknown") break;
                }
            }

            let isCompanyDriver = false;
            if (name === "Unknown") {
                for (let i = 0; i < textLines.length; i++) {
                    const txt = textLines[i].text.toUpperCase();
                    if (txt === 'STATEMENT' || txt.endsWith(' STATEMENT')) {
                        if (i + 1 < textLines.length) {
                            const nextTxt = textLines[i+1].text;
                            const isDate = /\d/.test(nextTxt) && (nextTxt.includes('-') || nextTxt.includes('/'));
                            const isUnit = /truck|unit|#/i.test(nextTxt);
                            
                            if (!isDate && !isUnit && nextTxt.length > 2) {
                                name = nextTxt;
                                isCompanyDriver = true;
                                break;
                            }
                        }
                    }
                }
            }

            if (isCompanyDriver) {
                unit = "";
            }

            if (name === "Unknown") {
                for (let i = 0; i < textLines.length; i++) {
                    const match = textLines[i].text.match(/(?:Driver|Driver Name|Pay to)\s*[:#.]?\s*([A-Za-z\s\.]+)/i);
                    if (match) {
                        name = match[1].trim();
                        break;
                    }
                }
            }

            // 4. EXTRACT TOTAL
            const fullItems = textContent.items.sort((a, b) => b.transform[5] - a.transform[5]);
            let fullLines = [];
            currentLine = [];
            lastY = -1;
            fullItems.forEach(item => {
                if (lastY === -1 || Math.abs(item.transform[5] - lastY) < 6) {
                    currentLine.push(item);
                } else {
                    currentLine.sort((a, b) => a.transform[4] - b.transform[4]);
                    fullLines.push(currentLine.map(i=>i.str).join(' '));
                    currentLine = [item];
                }
                lastY = item.transform[5];
            });
            if(currentLine.length) fullLines.push(currentLine.map(i=>i.str).join(' '));

            if (isCompanyDriver) {
                let checkTotalFound = false;
                for(let l of fullLines) {
                    const lower = l.toLowerCase();
                    if(lower.includes('check total') || lower.includes('net pay') || lower.includes('check amount')) {
                        const m = l.match(/(\d{1,3}(?:,\d{3})*\.\d{2})/);
                        if(m) { amount = parseFloat(m[1].replace(',','')); checkTotalFound=true; }
                    }
                }
                
                if (!checkTotalFound) {
                     for(let i = fullLines.length - 1; i >= 0; i--) {
                         if(fullLines[i].toLowerCase().includes('total')) {
                             const m = fullLines[i].match(/(\d{1,3}(?:,\d{3})*\.\d{2})/);
                             if(m) { amount = parseFloat(m[1].replace(',','')); break; }
                         }
                     }
                }

            } else {
                let tripFound = false;
                for(let l of fullLines) {
                    const lower = l.toLowerCase();
                    if(lower.includes('trip')) tripFound = true;
                    if(tripFound && lower.includes('total')) {
                        const m = l.match(/(\d{1,3}(?:,\d{3})*\.\d{2})/);
                        if(m) { amount = parseFloat(m[1].replace(',','')); break; }
                    }
                }
                if (amount === 0) {
                    for(let l of fullLines) {
                        if(l.toLowerCase().includes('total')) {
                            const m = l.match(/(\d{1,3}(?:,\d{3})*\.\d{2})/);
                            if(m) { amount = parseFloat(m[1].replace(',','')); break; }
                        }
                    }
                }
            }

            return {
                unit: unit,
                name: name,
                amount: amount,
                filename: file.name
            };
        }

        // --- RATE HELPER ---
        function getCommissionLabel(unitStr) {
            if (!unitStr) return ""; // Drivers don't have rate label
            if (unitStr.includes("287") || unitStr.includes("3781")) {
                return "(10%)";
            }
            return "(12%)";
        }

        // --- Aggregation & Rendering ---

        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            const footer = document.getElementById('tableFooter');
            const grandTotalEl = document.getElementById('grandTotal');
            
            // 1. FILTER DATA
            let filteredData = [];

            if (viewMode === 'current') {
                filteredData = appData.filter(item => item.company === currentCompany);
            } else {
                filteredData = appData; 
            }

            if(filteredData.length === 0) {
                const msg = viewMode === 'current' 
                    ? `No data for <b>${currentCompany}</b>. Upload files or switch companies.` 
                    : `No data uploaded yet.`;
                tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400 dark:text-gray-500">${msg}</td></tr>`;
                footer.classList.add('hidden');
                return;
            }

            footer.classList.remove('hidden');

            // 2. AGGREGATE
            const aggregated = {};

            filteredData.forEach(item => {
                let key = "";
                if (item.unit && item.unit !== "Unknown") {
                    key = item.unit.toUpperCase();
                } else {
                    key = item.name.toUpperCase();
                }
                
                if(!aggregated[key]) {
                    aggregated[key] = { 
                        unit: item.unit, 
                        name: item.name, 
                        totalAmount: 0, 
                        files: [] 
                    };
                }
                
                aggregated[key].totalAmount += item.amount;
                aggregated[key].files.push(item);
                
                if (aggregated[key].name === "Unknown" && item.name !== "Unknown") {
                    aggregated[key].name = item.name;
                }
            });

            // Split into Owners and Drivers
            const owners = [];
            const drivers = [];

            Object.values(aggregated).forEach(item => {
                if (item.unit && item.unit !== "") {
                    owners.push(item);
                } else {
                    drivers.push(item);
                }
            });

            // Sort logic
            const sortFn = (a, b) => {
                if (a.unit && b.unit) {
                    const numA = parseInt(a.unit.replace(/\D/g,''));
                    const numB = parseInt(b.unit.replace(/\D/g,''));
                    if(!isNaN(numA) && !isNaN(numB)) return numA - numB;
                }
                return (a.name || "").localeCompare(b.name || "");
            };

            owners.sort(sortFn);
            drivers.sort(sortFn);

            // 3. BUILD HTML
            let html = '';
            let totalSum = 0;

            // Render Function
            const renderRows = (list) => {
                list.forEach(group => {
                    totalSum += group.totalAmount;
                    const safeKey = group.unit ? group.unit.replace(/[^a-zA-Z0-9]/g, '_') : group.name.replace(/[^a-zA-Z0-9]/g, '_'); 

                    // Resolve Note
                    const noteKey = `${currentCompany}_${group.unit || group.name}`;
                    const hasNote = unitNotes[noteKey] && unitNotes[noteKey].trim() !== "";
                    const noteColor = hasNote ? "text-yellow-500 hover:text-yellow-600" : "text-gray-300 hover:text-gray-500";
                    const noteIcon = hasNote ? "fas fa-sticky-note" : "far fa-sticky-note";
                    
                    const displayUnit = group.unit || "";
                    
                    // Determine Rate Label (Only for owners)
                    const rateLabel = group.unit ? getCommissionLabel(group.unit) : "";

                    html += `
                        <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                            <td class="p-3 font-bold text-gray-800 dark:text-gray-200">${displayUnit}</td>
                            <td class="p-3 text-gray-600 dark:text-gray-400 flex items-center justify-between">
                                <span>${group.name}</span>
                                ${viewMode === 'current' ? `
                                <button onclick="openNotesModal('${group.unit || group.name}')" class="${noteColor} transition" title="Add/View Notes">
                                    <i class="${noteIcon} text-lg"></i>
                                </button>` : ''}
                            </td>
                            <td class="p-3 text-right font-mono font-medium text-blue-700 dark:text-blue-400">
                                $${group.totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})} 
                                <span class="text-xs text-gray-400 ml-1">${rateLabel}</span>
                            </td>
                            <td class="p-3 text-center">
                                <button onclick="toggleDetails('details-${safeKey}')" class="text-xs bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 px-3 py-1 rounded-full">
                                    ${viewMode === 'global' ? 'Breakdown' : group.files.length + ' Files'} <i class="fas fa-chevron-down ml-1"></i>
                                </button>
                            </td>
                        </tr>
                        <tr id="details-${safeKey}" class="hidden bg-gray-50/50 dark:bg-gray-900/50">
                            <td colspan="4" class="p-0">
                                <div class="p-4 pl-12 border-l-4 border-blue-200 dark:border-blue-800">
                                    <ul class="space-y-2">
                                        ${group.files.map(f => `
                                            <li class="flex justify-between items-center text-sm bg-white dark:bg-gray-800 p-2 rounded border border-gray-100 dark:border-gray-700">
                                                <div class="flex items-center gap-3">
                                                    <i class="far fa-file-pdf text-red-400"></i>
                                                    <span class="text-gray-600 dark:text-gray-400 truncate max-w-[150px]">${f.filename}</span>
                                                    <div class="flex gap-1">
                                                        <button onclick="openEditModal('${f.id}', '${f.unit}')" class="text-gray-300 hover:text-blue-500 transition px-1" title="Edit Unit #">
                                                            <i class="fas fa-pencil-alt text-xs"></i>
                                                        </button>
                                                        <button onclick="deleteFile('${f.id}')" class="text-gray-300 hover:text-red-500 transition px-1" title="Delete File">
                                                            <i class="fas fa-trash-alt text-xs"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <span class="font-mono text-gray-800 dark:text-gray-200">$${f.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            };

            // Render Owners
            if (owners.length > 0) {
                // html += `<tr class="bg-gray-100 font-bold text-gray-700"><td colspan="4" class="p-2 pl-4">OWNER OPERATORS</td></tr>`;
                renderRows(owners);
            }

            // Render Drivers
            if (drivers.length > 0) {
                html += `<tr class="bg-gray-200 dark:bg-gray-700 font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wider"><td colspan="4" class="p-3 pl-4 border-t-2 border-gray-300 dark:border-gray-600">DRIVERS</td></tr>`;
                renderRows(drivers);
            }

            tbody.innerHTML = html;
            grandTotalEl.innerText = "$" + totalSum.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        // --- Interaction Helpers --- (Same as before)
        function toggleDetails(rowId) {
            const el = document.getElementById(rowId);
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                el.classList.add('fade-in');
            } else {
                el.classList.add('hidden');
            }
        }
        function deleteFile(id) {
            fileToDeleteId = id;
            document.getElementById('deleteFileModal').classList.remove('hidden');
        }
        function closeDeleteFileModal() {
            document.getElementById('deleteFileModal').classList.add('hidden');
            fileToDeleteId = null;
        }
        function confirmDeleteFile() {
            if (fileToDeleteId) {
                appData = appData.filter(d => d.id !== fileToDeleteId);
                renderTable();
                closeDeleteFileModal();
            }
        }
        let currentEditId = null;
        function openEditModal(fileId, currentUnit) {
            currentEditId = fileId;
            const input = document.getElementById('editUnitInput');
            input.value = currentUnit;
            document.getElementById('editModal').classList.remove('hidden');
            input.focus();
        }
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditId = null;
        }
        function saveUnitEdit() {
            const newUnit = document.getElementById('editUnitInput').value.trim();
            if(!newUnit) return;
            const item = appData.find(d => d.id === currentEditId);
            if(item) {
                item.unit = newUnit;
                renderTable();
                closeEditModal();
            }
        }
        function openNotesModal(unitKey) {
            const key = `${currentCompany}_${unitKey}`;
            document.getElementById('noteUnitDisplay').innerText = unitKey;
            document.getElementById('noteKey').value = key;
            document.getElementById('noteInput').value = unitNotes[key] || "";
            document.getElementById('notesModal').classList.remove('hidden');
            document.getElementById('noteInput').focus();
        }
        function closeNotesModal() {
            document.getElementById('notesModal').classList.add('hidden');
        }
        function saveNote() {
            const key = document.getElementById('noteKey').value;
            const val = document.getElementById('noteInput').value;
            unitNotes[key] = val;
            renderTable();
            closeNotesModal();
        }
        function openClearModal() {
            document.getElementById('clearModal').classList.remove('hidden');
        }
        function closeClearModal() {
            document.getElementById('clearModal').classList.add('hidden');
        }
        function confirmClear() {
            if (viewMode === 'global') {
                appData = [];
                unitNotes = {};
                knownCompanies = ["Default Company"];
                currentCompany = "Default Company";
            } else {
                appData = appData.filter(item => item.company !== currentCompany);
            }
            renderTable();
            closeClearModal();
        }
        function backupData() {
            if(appData.length === 0) return;
            const backupPayload = {
                version: 2,
                appData: appData,
                unitNotes: unitNotes,
                knownCompanies: knownCompanies
            };
            const dataStr = JSON.stringify(backupPayload, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Generate filename with date and time (YYYY-MM-DD_HH-MM-SS)
            const now = new Date();
            const dateStr = now.getFullYear() + '-' + 
                           String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(now.getDate()).padStart(2, '0') + '_' + 
                           String(now.getHours()).padStart(2, '0') + '-' + 
                           String(now.getMinutes()).padStart(2, '0') + '-' + 
                           String(now.getSeconds()).padStart(2, '0');
            
            a.href = url;
            a.download = `1099_manager_backup_${dateStr}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        function restoreData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    restoreCandidate = json;
                    document.getElementById('restoreModal').classList.remove('hidden');
                } catch(err) {
                    console.error("Error reading backup file", err);
                    alert("Invalid backup file.");
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }
        function closeRestoreModal() {
            document.getElementById('restoreModal').classList.add('hidden');
            restoreCandidate = null;
        }
        function confirmRestore() {
            if (restoreCandidate) {
                if(Array.isArray(restoreCandidate)) {
                    appData = restoreCandidate;
                    unitNotes = {}; 
                    const companies = new Set(["Default Company"]);
                    appData.forEach(d => { if(d.company) companies.add(d.company); });
                    knownCompanies = Array.from(companies);
                } else {
                    appData = restoreCandidate.appData || [];
                    unitNotes = restoreCandidate.unitNotes || {};
                    knownCompanies = restoreCandidate.knownCompanies || ["Default Company"];
                }
                if(appData.length > 0 && appData[appData.length-1].company) {
                    currentCompany = appData[appData.length-1].company;
                } else {
                    currentCompany = knownCompanies[0];
                }
                updateCompanyDropdown();
                renderTable();
                closeRestoreModal();
            }
        }

        // --- PDF Report ---
        function printReport() {
            const tbody = document.getElementById('dataTableBody');
            if(tbody.innerText.includes("No data")) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const title = viewMode === 'current' 
                ? `Settlement Report: ${currentCompany}`
                : "Global Yearly Settlement Report";

            doc.setFontSize(16);
            doc.text(title, 14, 20);
            doc.setFontSize(10);
            doc.text("Generated: " + new Date().toLocaleString(), 14, 28);

            let filteredData = [];
            if (viewMode === 'current') {
                filteredData = appData.filter(item => item.company === currentCompany);
            } else {
                filteredData = appData;
            }

            const aggregated = {};
            filteredData.forEach(item => {
                let key = "";
                if (item.unit && item.unit !== "Unknown") {
                    key = item.unit.toUpperCase();
                } else {
                    key = item.name.toUpperCase();
                }
                if(!aggregated[key]) {
                    aggregated[key] = { unit: item.unit, name: item.name, total: 0 };
                }
                aggregated[key].total += item.amount;
                if(aggregated[key].name === "Unknown" && item.name !== "Unknown") aggregated[key].name = item.name;
            });

            // Split
            const owners = [];
            const drivers = [];
            Object.values(aggregated).forEach(item => {
                if(item.unit && item.unit !== "") owners.push(item);
                else drivers.push(item);
            });

            // Sort
            const sortFn = (a, b) => {
                if (a.unit && b.unit) {
                    const numA = parseInt(a.unit.replace(/\D/g,''));
                    const numB = parseInt(b.unit.replace(/\D/g,''));
                    if(!isNaN(numA) && !isNaN(numB)) return numA - numB;
                }
                return (a.name || "").localeCompare(b.name || "");
            };
            owners.sort(sortFn);
            drivers.sort(sortFn);

            let finalY = 35;

            // 1. OWNER TABLE
            if(owners.length > 0) {
                const ownerRows = owners.map(row => {
                    let nameDisplay = row.name;
                    if(viewMode === 'current') {
                        const noteKey = `${currentCompany}_${row.unit}`;
                        if(unitNotes[noteKey]) nameDisplay += ` (Note: ${unitNotes[noteKey]})`;
                    }
                    const rateLabel = getCommissionLabel(row.unit);
                    return [
                        row.unit,
                        nameDisplay,
                        "$" + row.total.toLocaleString('en-US', {minimumFractionDigits: 2}) + " " + rateLabel
                    ];
                });

                // Add Owner Total
                const ownerSum = owners.reduce((acc, curr) => acc + curr.total, 0);
                ownerRows.push(["", "TOTAL OWNERS", "$" + ownerSum.toLocaleString('en-US', {minimumFractionDigits: 2})]);

                doc.autoTable({
                    head: [['Unit #', 'Driver Name / Notes', 'After Commission']],
                    body: ownerRows,
                    startY: finalY,
                    theme: 'grid',
                    headStyles: { fillColor: viewMode === 'current' ? [41, 128, 185] : [46, 204, 113] },
                    columnStyles: { 2: { halign: 'right' } },
                    didParseCell: function(data) {
                        if (data.row.index === ownerRows.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [240, 240, 240];
                        }
                    }
                });
                finalY = doc.lastAutoTable.finalY + 15;
            }

            // 2. DRIVER TABLE (No Unit, No Commission Label)
            if(drivers.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text("DRIVERS", 14, finalY);
                finalY += 5;

                const driverRows = drivers.map(row => {
                    let nameDisplay = row.name;
                    if(viewMode === 'current') {
                        const noteKey = `${currentCompany}_${row.name}`;
                        if(unitNotes[noteKey]) nameDisplay += ` (Note: ${unitNotes[noteKey]})`;
                    }
                    return [
                        nameDisplay,
                        "$" + row.total.toLocaleString('en-US', {minimumFractionDigits: 2})
                    ];
                });

                const driverSum = drivers.reduce((acc, curr) => acc + curr.total, 0);
                driverRows.push(["TOTAL DRIVERS", "$" + driverSum.toLocaleString('en-US', {minimumFractionDigits: 2})]);

                doc.autoTable({
                    head: [['Driver Name / Notes', 'Total Pay']],
                    body: driverRows,
                    startY: finalY,
                    theme: 'grid',
                    headStyles: { fillColor: [100, 100, 100] }, // Different color for drivers?
                    columnStyles: { 1: { halign: 'right' } },
                    didParseCell: function(data) {
                        if (data.row.index === driverRows.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [240, 240, 240];
                        }
                    }
                });
                finalY = doc.lastAutoTable.finalY + 15;
            }

            // Optional Grand Total
            const totalSum = filteredData.reduce((acc, curr) => acc + curr.amount, 0);
            
            // Only show Grand Total if we had both sections, otherwise the specific total is enough
            if(owners.length > 0 && drivers.length > 0) {
                doc.setFontSize(12);
                // Calculate right alignment position (Page Width - Margin)
                const pageWidth = doc.internal.pageSize.getWidth();
                doc.text(
                    "GRAND TOTAL: $" + totalSum.toLocaleString('en-US', {minimumFractionDigits: 2}), 
                    pageWidth - 14, 
                    finalY, 
                    { align: 'right' }
                );
            }

            doc.save("Settlement_Report.pdf");
        }

        window.toggleTheme = function() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                updateBulbIcon(false);
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                updateBulbIcon(true);
            }
        };

        function updateBulbIcon(isDark) {
            const bulb = document.getElementById('themeIcon');
            if(bulb) {
                if (isDark) {
                    bulb.classList.remove('text-gray-400');
                    bulb.classList.add('text-yellow-400');
                    bulb.style.filter = "drop-shadow(0 0 5px #facc15)";
                } else {
                    bulb.classList.remove('text-yellow-400');
                    bulb.classList.add('text-gray-400');
                    bulb.style.filter = "none";
                }
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (window.initApp) {
                window.initApp();
            }
        });
    </script>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="max-w-6xl mx-auto px-4 py-6">
        <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl font-bold">1099 Manager</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">Upload settlement PDFs and track totals by unit.</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-sm text-gray-500 dark:text-gray-400">Hi, <span id="userName" class="font-semibold text-gray-800 dark:text-gray-200">User</span></div>
                <button onclick="toggleTheme()" class="p-2 rounded-full bg-white dark:bg-gray-800 shadow">
                    <i id="themeIcon" class="fas fa-lightbulb text-gray-400"></i>
                </button>
                <button onclick="logout()" class="px-3 py-2 rounded-md bg-red-500 text-white text-sm font-semibold">Logout</button>
            </div>
        </header>

        <section class="mt-6 grid gap-4 md:grid-cols-[2fr,1fr]">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-5">
                <div class="flex flex-wrap items-center gap-3 justify-between">
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-semibold" for="companySelect">Company</label>
                        <select id="companySelect" class="border border-gray-200 dark:border-gray-700 rounded-md px-2 py-1 bg-white dark:bg-gray-900 text-sm" onchange="currentCompany=this.value; renderTable();"></select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="viewCurrentBtn" onclick="setViewMode('current')" class="px-3 py-1.5 rounded-md text-sm font-semibold bg-indigo-600 text-white">Current</button>
                        <button id="viewGlobalBtn" onclick="setViewMode('global')" class="px-3 py-1.5 rounded-md text-sm font-semibold bg-gray-200 text-gray-700">Global</button>
                    </div>
                </div>

                <div id="dropZone" class="mt-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Drag & drop settlement PDFs here, or</p>
                    <label class="mt-3 inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md cursor-pointer text-sm font-semibold">
                        <i class="fas fa-upload"></i> Choose Files
                        <input type="file" class="hidden" accept="application/pdf" multiple onchange="handleFiles(this.files)">
                    </label>
                </div>

                <div id="processingStatus" class="hidden mt-4">
                    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                        <span>Processingâ€¦</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="mt-2 h-2 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden">
                        <div id="progressBar" class="h-full bg-indigo-600 w-0"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-5 space-y-3">
                <h2 class="text-sm font-semibold uppercase text-gray-500 dark:text-gray-400">Cloud + Backup</h2>
                <div class="flex gap-2">
                    <button id="btnSaveCloud" onclick="saveToCloud()" class="flex-1 px-3 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold">Save Cloud</button>
                    <button id="btnLoadCloud" onclick="loadFromCloud()" class="flex-1 px-3 py-2 rounded-md bg-gray-200 text-gray-700 text-sm font-semibold">Load Cloud</button>
                </div>
                <p id="cloudStatus" class="text-xs text-gray-400">Not synced yet.</p>

                <div class="flex gap-2">
                    <button onclick="backupData()" class="flex-1 px-3 py-2 rounded-md bg-blue-600 text-white text-sm font-semibold">Backup</button>
                    <label class="flex-1 px-3 py-2 rounded-md bg-gray-200 text-gray-700 text-sm font-semibold text-center cursor-pointer">
                        Restore
                        <input type="file" class="hidden" accept="application/json" onchange="restoreData(this)">
                    </label>
                </div>

                <button onclick="printReport()" class="w-full px-3 py-2 rounded-md bg-green-600 text-white text-sm font-semibold">Export PDF Report</button>
                <button onclick="openClearModal()" class="w-full px-3 py-2 rounded-md bg-red-500 text-white text-sm font-semibold">Clear Data</button>
            </div>
        </section>

        <section class="mt-6 bg-white dark:bg-gray-800 rounded-xl shadow">
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold">Settlement Totals</h2>
                <div class="text-sm text-gray-500 dark:text-gray-400">Grand Total: <span id="grandTotal" class="font-semibold text-gray-800 dark:text-gray-200">$0.00</span></div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-900/30 text-left text-gray-500 dark:text-gray-400">
                        <tr>
                            <th class="p-3">Unit</th>
                            <th class="p-3">Driver</th>
                            <th class="p-3 text-right">Amount</th>
                            <th class="p-3 text-center">Details</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                    <tfoot id="tableFooter" class="hidden">
                        <tr>
                            <td colspan="4" class="p-3 text-xs text-gray-400">Totals update automatically after uploads.</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>
    </div>

    <div id="deleteFileModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <h3 class="text-lg font-semibold">Delete File</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Are you sure you want to delete this entry?</p>
            <div class="flex gap-2 justify-end">
                <button onclick="closeDeleteFileModal()" class="px-3 py-2 rounded-md bg-gray-200 text-gray-700 text-sm">Cancel</button>
                <button onclick="confirmDeleteFile()" class="px-3 py-2 rounded-md bg-red-500 text-white text-sm">Delete</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <h3 class="text-lg font-semibold">Edit Unit #</h3>
            <input id="editUnitInput" class="w-full px-3 py-2 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900" placeholder="Unit number">
            <div class="flex gap-2 justify-end">
                <button onclick="closeEditModal()" class="px-3 py-2 rounded-md bg-gray-200 text-gray-700 text-sm">Cancel</button>
                <button onclick="saveUnitEdit()" class="px-3 py-2 rounded-md bg-indigo-600 text-white text-sm">Save</button>
            </div>
        </div>
    </div>

    <div id="notesModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <h3 class="text-lg font-semibold">Notes for <span id="noteUnitDisplay"></span></h3>
            <input type="hidden" id="noteKey">
            <textarea id="noteInput" class="w-full px-3 py-2 rounded-md border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900" rows="4" placeholder="Add a note..."></textarea>
            <div class="flex gap-2 justify-end">
                <button onclick="closeNotesModal()" class="px-3 py-2 rounded-md bg-gray-200 text-gray-700 text-sm">Cancel</button>
                <button onclick="saveNote()" class="px-3 py-2 rounded-md bg-indigo-600 text-white text-sm">Save</button>
            </div>
        </div>
    </div>

    <div id="clearModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <h3 class="text-lg font-semibold">Clear Data</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">This will remove data for the selected view.</p>
            <div class="flex gap-2 justify-end">
                <button onclick="closeClearModal()" class="px-3 py-2 rounded-md bg-gray-200 text-gray-700 text-sm">Cancel</button>
                <button onclick="confirmClear()" class="px-3 py-2 rounded-md bg-red-500 text-white text-sm">Clear</button>
            </div>
        </div>
    </div>

    <div id="restoreModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm space-y-4">
            <h3 class="text-lg font-semibold">Restore Backup</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">Replace current data with the selected backup?</p>
            <div class="flex gap-2 justify-end">
                <button onclick="closeRestoreModal()" class="px-3 py-2 rounded-md bg-gray-200 text-gray-700 text-sm">Cancel</button>
                <button onclick="confirmRestore()" class="px-3 py-2 rounded-md bg-indigo-600 text-white text-sm">Restore</button>
            </div>
        </div>
    </div>
</body>
</html>
