<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tools Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // 1. SETTINGS
        const firebaseConfig = {
            apiKey: "AIzaSyDjtmRPzKilbqHGt57SvVm5fo3KyZ9D03U",
            authDomain: "truck-dashboard-18d7e.firebaseapp.com",
            projectId: "truck-dashboard-18d7e",
            storageBucket: "truck-dashboard-18d7e.firebasestorage.app",
            messagingSenderId: "594927367199",
            appId: "1:594927367199:web:4f3c5af05f4cfdb482112a",
            measurementId: "G-42RMFB41Q2"
        };

        const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxAm91gXdGCdRPw3FLR9Gji5VBr1fCyg2kVIt9kv0wiDYQ7GdMwv9iQxMLsfOnvQKqq/exec";

        // Firebase Initialization
        let app, auth;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
        } catch(e) { console.error("Firebase error", e); }

        // Main Function
        async function initDashboard() {
            // --- 1. ADMIN CHECK (OVO JE FALILO!) ---
            if (localStorage.getItem('admin_mode') === 'true') {
                const userEl = document.getElementById('userName');
                if (userEl) {
                    userEl.innerHTML = '<span class="text-green-500 font-bold">Administrator</span>';
                }
                // Ako je admin, prekidamo funkciju ovde - ne proveravamo kljuceve!
                return; 
            }

            // --- 2. NORMAL USER CHECKS ---
            const key = localStorage.getItem('my_access_key');
            
            if (!key) {
                goHome();
                return;
            }

            if (auth) {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const rawName = user.email.split('@')[0];
                        const niceName = rawName.charAt(0).toUpperCase() + rawName.slice(1);
                        const el = document.getElementById('userName');
                        if (el) el.innerText = niceName;
                        
                        validateSession(key); 
                    } else {
                        goHome();
                    }
                });
            } else {
                const el = document.getElementById('userName');
                if (el) el.innerText = "User";
            }
        }

        async function validateSession(key) {
            if (!SHEET_API_URL) return;
            try {
                const response = await fetch(`${SHEET_API_URL}?action=verify&key=${encodeURIComponent(key)}`);
                const data = await response.json();
                if (data.status !== 'allowed') {
                    alert("Access key has expired or is banned.");
                    logout();
                }
            } catch (e) { console.error("Offline check", e); }
        }
        
        window.logout = function() {
            localStorage.removeItem('my_access_key');
            localStorage.removeItem('admin_mode'); // Brise i admin status
            
            if (auth) {
                signOut(auth).then(() => goHome()).catch(() => goHome());
            } else {
                goHome();
            }
        };

        function goHome() {
            try {
                if (window.location.protocol !== 'blob:') {
                    window.location.href = "index.html";
                } else {
                    throw new Error("Preview mode");
                }
            } catch (e) {
                console.warn("Redirection blocked (preview mode). Showing fallback.");
                document.body.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-screen bg-gray-50 text-gray-800 font-sans">
                        <div class="bg-white p-8 rounded-xl shadow-lg text-center max-w-md">
                            <i class="fas fa-lock text-4xl text-blue-600 mb-4"></i>
                            <h1 class="text-2xl font-bold mb-2">Authentication Required</h1>
                            <p class="text-gray-600 mb-6">You need to log in to access this dashboard.</p>
                            <a href="index.html" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition inline-block">
                                Go to Login Page
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        // Theme Logic
        window.toggleTheme = function() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                updateBulbIcon(false);
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                updateBulbIcon(true);
            }
        };

        function updateBulbIcon(isDark) {
            const bulb = document.getElementById('themeIcon');
            if (isDark) {
                bulb.classList.remove('text-gray-400');
                bulb.classList.add('text-yellow-400', 'bulb-on');
            } else {
                bulb.classList.remove('text-yellow-400', 'bulb-on');
                bulb.classList.add('text-gray-400');
            }
        }
        
        // Init Theme
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            updateBulbIcon(true);
        }

        initDashboard();
    </script>
    
    <style>
        .bulb-on { filter: drop-shadow(0 0 5px #facc15); }
        .bulb-shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%,100%{transform:rotate(0deg)} 25%{transform:rotate(15deg)} 75%{transform:rotate(-15deg)} }
        body, .tool-card, nav { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800 bg-gray-50 font-sans dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Navbar -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm p-4 sticky top-0 z-50 transition-colors duration-300">
        <div class="container mx-auto flex justify-between items-center">
            <div class="font-bold text-xl text-gray-700 dark:text-white flex items-center">
                <i class="fas fa-cubes text-blue-600 mr-2"></i> Dashboard
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition focus:outline-none ring-1 ring-gray-200 dark:ring-gray-600">
                    <svg id="themeIcon" class="w-6 h-6 text-gray-400 transition-all duration-300" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 10 2 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"></path></svg>
                </button>

                <!-- User Info -->
                <div class="hidden md:flex items-center text-sm font-medium text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 px-3 py-1.5 rounded-full border dark:border-gray-600">
                    <i class="fas fa-user-circle text-blue-500 mr-2 text-lg"></i>
                    <span id="userName">Loading...</span>
                </div>

                <!-- Logout Button -->
                <button onclick="logout()" class="text-xs font-bold text-red-500 hover:text-white border border-red-200 dark:border-red-900 hover:bg-red-500 px-4 py-2 rounded-lg transition shadow-sm flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i> Log Out
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-12">
        
        <div class="text-center mb-12">
            <h1 class="text-4xl font-extrabold text-gray-800 dark:text-white mb-4">Welcome Back!</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">All your tools in one place.</p>
        </div>

        <!-- Tool Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl mx-auto">
            
            <!-- TOOL 1: 1099 Manager -->
            <a href="1099.html" class="tool-card bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden cursor-pointer group hover:ring-2 ring-blue-500 transition hover:-translate-y-1 block relative border border-transparent dark:border-gray-700">
                <div class="bg-blue-600 p-6 flex justify-center items-center h-40">
                    <i class="fas fa-truck-moving text-6xl text-white opacity-90 group-hover:scale-110 transition-transform duration-300"></i>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">1099 Manager</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">Settlement calculation, PDF analysis, and driver reports.</p>
                    <div class="flex items-center text-blue-600 dark:text-blue-400 font-bold text-sm uppercase tracking-wide">
                        Open Tool <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition"></i>
                    </div>
                </div>
            </a>
            
            <!-- TOOL 2: Payroll -->
            <a href="plate.html" class="tool-card bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden cursor-pointer group hover:ring-2 ring-green-500 transition hover:-translate-y-1 block relative border border-transparent dark:border-gray-700">
                <div class="bg-green-600 p-6 flex justify-center items-center h-40">
                    <i class="fas fa-money-check-alt text-6xl text-white opacity-90 group-hover:scale-110 transition-transform duration-300"></i>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Payroll</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">Calculator for salaries, bonuses, and employee deductions.</p>
                    <div class="flex items-center text-green-600 dark:text-green-400 font-bold text-sm uppercase tracking-wide">
                        Open Tool <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition"></i>
                    </div>
                </div>
            </a>
            
            <!-- TOOL 3: Notes -->
            <a href="#" onclick="alert('Coming soon!')" class="tool-card bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden cursor-pointer group hover:ring-2 ring-yellow-500 transition hover:-translate-y-1 block relative border border-transparent dark:border-gray-700">
                <div class="bg-yellow-500 p-6 flex justify-center items-center h-40 opacity-90">
                    <i class="fas fa-sticky-note text-6xl text-white opacity-90 group-hover:scale-110 transition-transform duration-300"></i>
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Notes</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">Quick reminders and important information.</p>
                    <div class="flex items-center text-yellow-600 dark:text-yellow-400 font-bold text-sm uppercase tracking-wide">
                        Coming soon...
                    </div>
                </div>
            </a>

        </div>
    </main>
    
    <footer class="text-center text-gray-400 dark:text-gray-500 text-sm py-8 border-t border-gray-200 dark:border-gray-700 mt-auto">
        &copy; 2026 My Tools Hub. All rights reserved.
    </footer>
</body>
</html>
