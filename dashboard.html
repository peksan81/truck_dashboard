<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // SETTINGS
        const firebaseConfig = {
            apiKey: "AIzaSyDjtmRPzKilbqHGt57SvVm5fo3KyZ9D03U",
            authDomain: "truck-dashboard-18d7e.firebaseapp.com",
            projectId: "truck-dashboard-18d7e",
            storageBucket: "truck-dashboard-18d7e.firebasestorage.app",
            messagingSenderId: "594927367199",
            appId: "1:594927367199:web:4f3c5af05f4cfdb482112a",
            measurementId: "G-42RMFB41Q2"
        };
        const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxAm91gXdGCdRPw3FLR9Gji5VBr1fCyg2kVIt9kv0wiDYQ7GdMwv9iQxMLsfOnvQKqq/exec";

        let app, auth, provider;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            provider = new GoogleAuthProvider();
            setPersistence(auth, browserLocalPersistence);
        } catch (e) { console.error(e); }

        // --- LOGIC ---
        window.checkGateCode = async function() {
            const btn = document.getElementById('verifyBtn');
            const key = document.getElementById('gateInput').value.trim();
            if (!key) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';

            try {
                const response = await fetch(`${SHEET_API_URL}?action=verify&key=${encodeURIComponent(key)}`);
                const data = await response.json();

                if (data.status === 'allowed') {
                    localStorage.setItem('my_access_key', key);
                    // If google is ready, go to dashboard, else show google button
                    if (auth.currentUser) {
                        registerUserInDb(key, auth.currentUser.email);
                        window.location.href = "dashboard.html";
                    } else {
                        document.getElementById('step1').classList.add('hidden');
                        document.getElementById('step2').classList.remove('hidden');
                    }
                } else {
                    alert("Access Denied: " + (data.message || "Invalid Key"));
                }
            } catch (e) {
                alert("Connection Error. Please check your internet.");
            }
            btn.disabled = false;
            btn.innerText = 'Verify';
        };

        window.loginWithGoogle = function() {
            signInWithPopup(auth, provider).then((result) => {
                const key = localStorage.getItem('my_access_key');
                registerUserInDb(key, result.user.email);
                window.location.href = "dashboard.html";
            }).catch(e => alert(e.message));
        };

        function registerUserInDb(key, email) {
            fetch(`${SHEET_API_URL}?action=register_user&key=${key}&user=${email}`, { method: "POST", mode: "no-cors" });
        }

        // Auto-redirect if already logged in
        if(auth) {
            onAuthStateChanged(auth, (user) => {
                const key = localStorage.getItem('my_access_key');
                if (user && key) {
                    // Quick check - redirect immediately
                    window.location.href = "dashboard.html";
                } else {
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('loginBox').classList.remove('hidden');
                    
                    if (key) {
                         document.getElementById('step1').classList.add('hidden');
                         document.getElementById('step2').classList.remove('hidden');
                    }
                }
            });
        }
    </script>
</head>
<body class="bg-gray-900 min-h-screen flex items-center justify-center font-sans">

    <!-- Loader -->
    <div id="loader" class="text-white text-center">
        <i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i>
        <p>Checking security...</p>
    </div>

    <!-- Login Box -->
    <div id="loginBox" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md hidden">
        
        <!-- Step 1: Code -->
        <div id="step1">
            <div class="text-center mb-6">
                <i class="fas fa-shield-alt text-4xl text-blue-600 mb-2"></i>
                <h1 class="text-2xl font-bold text-gray-800">Secure Entry</h1>
                <p class="text-gray-500 text-sm">Please enter access key</p>
            </div>
            <form onsubmit="event.preventDefault(); checkGateCode();" class="space-y-4">
                <input type="password" id="gateInput" class="w-full border-2 border-gray-200 rounded-lg p-3 text-center text-xl tracking-widest focus:border-blue-500 outline-none" placeholder="••••••••" autofocus>
                <button type="submit" id="verifyBtn" class="w-full bg-gray-900 hover:bg-black text-white py-3 rounded-lg font-bold transition">Verify</button>
            </form>
        </div>

        <!-- Step 2: Google -->
        <div id="step2" class="hidden text-center">
             <div class="text-center mb-6">
                <i class="fab fa-google text-4xl text-blue-600 mb-2"></i>
                <h1 class="text-2xl font-bold text-gray-800">Verify Identity</h1>
                <p class="text-gray-500 text-sm mb-4">Key accepted. Verify with Google.</p>
            </div>
            <button onclick="loginWithGoogle()" class="w-full border border-gray-300 py-3 rounded-lg font-bold hover:bg-gray-50 flex items-center justify-center gap-2 mb-4">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Sign in with Google
            </button>
            <button onclick="localStorage.removeItem('my_access_key'); location.reload()" class="text-xs text-gray-400 underline hover:text-gray-600">Change Key</button>
        </div>

    </div>

</body>
</html>
